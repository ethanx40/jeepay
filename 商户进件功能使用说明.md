# 商户进件功能使用说明

## 功能概述

商户进件功能是Jeepay支付系统的重要组成部分，允许商户通过平台向各支付渠道（微信支付、支付宝、云闪付等）提交入驻申请，实现一站式接入多个支付渠道。

## 已实现功能

### 1. 数据库设计
- ✅ `t_mch_apply_record` - 商户进件申请记录表
- ✅ `t_mch_apply_material` - 进件材料表  
- ✅ `t_mch_apply_audit_record` - 进件审核记录表
- ✅ `t_channel_apply_config` - 渠道进件配置表

### 2. 核心实体类
- ✅ `MchApplyRecord` - 进件申请记录实体
- ✅ `MchApplyMaterial` - 进件材料实体
- ✅ `MchApplyAuditRecord` - 审核记录实体
- ✅ `ChannelApplyConfig` - 渠道配置实体

### 3. 业务服务层
- ✅ `MchApplyService` - 核心进件业务服务
- ✅ `MchApplyRecordService` - 申请记录服务
- ✅ `MchApplyMaterialService` - 材料管理服务
- ✅ `ChannelApplyConfigService` - 渠道配置服务

### 4. 渠道适配层
- ✅ `IChannelApplyService` - 渠道进件服务接口
- ✅ `WxpayApplyService` - 微信支付进件服务（框架实现）

### 5. API接口层
- ✅ `MchApplyController` - 商户端进件申请接口
- ✅ `MchApplyMgrController` - 管理端进件管理接口
- ✅ `MaterialUploadController` - 材料上传接口

## 部署步骤

### 1. 执行数据库脚本
```sql
-- 执行进件功能相关表结构
source docs/sql/mch_apply_tables.sql;
```

### 2. 重新编译项目
```bash
# 清理并重新编译
mvn clean compile

# 或者完整构建
mvn clean package -DskipTests
```

### 3. 重启相关服务
```bash
# 重启商户系统
# 重启管理系统
# 重启支付网关（如果有相关修改）
```

## 使用流程

### 商户端操作流程

#### 1. 查看支持的支付渠道
```http
GET /api/mchApply/channels
Authorization: Bearer {token}
```

#### 2. 上传进件材料
```http
POST /api/mchApply/material/upload
Content-Type: multipart/form-data

file: {材料文件}
materialType: BUSINESS_LICENSE
```

#### 3. 提交进件申请
```http
POST /api/mchApply/submit
Content-Type: application/json

{
  "channelCode": "WX_PAY",
  "merchantInfo": {
    "merchantName": "测试商户",
    "merchantType": 1,
    "businessLicense": "123456789",
    "creditCode": "91110000123456789X"
  },
  "contactInfo": {
    "contactName": "张三",
    "contactMobile": "13800138000",
    "contactEmail": "test@example.com",
    "contactIdNumber": "110101199001011234"
  },
  "materials": [
    {
      "materialType": "BUSINESS_LICENSE",
      "materialName": "营业执照",
      "fileUrl": "/uploads/materials/M001/BUSINESS_LICENSE/xxx.jpg",
      "fileName": "营业执照.jpg",
      "isRequired": true
    }
  ]
}
```

#### 4. 查询申请状态
```http
GET /api/mchApply/list?pageNumber=1&pageSize=20
Authorization: Bearer {token}
```

#### 5. 查看申请详情
```http
GET /api/mchApply/{applyId}
Authorization: Bearer {token}
```

### 管理端操作流程

#### 1. 查看所有进件申请
```http
GET /api/mchApply/list?pageNumber=1&pageSize=20
Authorization: Bearer {admin_token}
```

#### 2. 查看申请详情
```http
GET /api/mchApply/{applyId}
Authorization: Bearer {admin_token}
```

#### 3. 审核申请
```http
POST /api/mchApply/{applyId}/audit
Content-Type: application/json

{
  "auditStatus": 1,
  "auditOpinion": "材料齐全，审核通过"
}
```

#### 4. 管理渠道配置
```http
GET /api/mchApply/config/list
PUT /api/mchApply/config/{configId}
PUT /api/mchApply/config/{configId}/enabled?isEnabled=1
```

## 状态说明

### 申请状态
- `0` - 草稿：申请已创建但未提交
- `1` - 已提交：申请已提交，等待平台审核
- `2` - 渠道处理中：平台审核通过，已提交到支付渠道
- `3` - 审核通过：渠道审核通过，可以使用支付功能
- `4` - 审核拒绝：审核被拒绝
- `5` - 已取消：申请被取消

### 材料类型
- `BUSINESS_LICENSE` - 营业执照
- `ID_CARD_FRONT` - 身份证正面
- `ID_CARD_BACK` - 身份证反面
- `BANK_ACCOUNT` - 银行开户许可证
- `ORGANIZATION_CODE` - 组织机构代码证
- `TAX_REGISTRATION` - 税务登记证

## 权限配置

### 商户系统权限
- `ENT_MCH_APPLY_INFO` - 商户进件菜单
- `ENT_MCH_APPLY_SUBMIT` - 提交进件申请
- `ENT_MCH_APPLY_QUERY` - 查询进件状态

### 管理系统权限
- `ENT_MCH_APPLY_LIST` - 商户进件管理菜单
- `ENT_MCH_APPLY_VIEW` - 查看进件申请
- `ENT_MCH_APPLY_AUDIT` - 审核进件申请
- `ENT_MCH_APPLY_CONFIG` - 进件配置管理

## 扩展指南

### 1. 新增支付渠道进件

#### 步骤1：实现渠道进件服务
```java
@Service("alipayApplyService")
public class AlipayApplyService implements IChannelApplyService {
    
    @Override
    public String getChannelCode() {
        return "ALI_PAY";
    }
    
    @Override
    public ChannelApplyResult submitToChannel(MchApplyInfo applyInfo) {
        // 实现支付宝进件API调用
        return null;
    }
    
    // 实现其他方法...
}
```

#### 步骤2：配置渠道信息
```sql
INSERT INTO t_channel_apply_config (config_id, channel_code, config_name, required_materials, is_enabled) 
VALUES ('NEW_CHANNEL_CONFIG', 'NEW_CHANNEL', '新渠道进件配置', '[]', 1);
```

### 2. 自定义材料类型

#### 步骤1：扩展材料类型常量
```java
public interface MaterialType {
    String CUSTOM_MATERIAL = "CUSTOM_MATERIAL";  // 自定义材料
}
```

#### 步骤2：更新渠道配置
```json
{
  "type": "CUSTOM_MATERIAL",
  "name": "自定义材料",
  "required": true
}
```

### 3. 集成外部存储

#### 修改文件上传逻辑
```java
// 在MaterialUploadController中集成OSS
@Autowired
private OssService ossService;

public ApiRes<MaterialUploadResult> uploadMaterial(MultipartFile file) {
    // 上传到OSS
    String fileUrl = ossService.upload(file);
    // 返回结果
}
```

## 注意事项

### 1. 安全考虑
- 文件上传需要验证文件类型和大小
- 敏感信息需要加密存储
- API接口需要权限验证

### 2. 性能优化
- 大文件上传建议使用分片上传
- 材料预览可以使用CDN加速
- 数据库查询建议添加适当索引

### 3. 监控告警
- 进件申请量监控
- 审核通过率监控
- 文件上传失败监控

## 后续开发计划

### 第二阶段功能
- [ ] 支付宝进件API对接
- [ ] 云闪付进件API对接
- [ ] 进件状态自动查询
- [ ] 批量进件功能

### 第三阶段功能
- [ ] 进件审核工作流
- [ ] 进件数据统计分析
- [ ] 移动端进件支持
- [ ] 进件模板功能

## 技术支持

如有问题，请联系开发团队或查看相关文档：
- 项目文档：`Jeepay项目分析与知识点梳理.md`
- 设计方案：`商户进件功能设计方案.md`
- 代码仓库：查看相关源码和注释