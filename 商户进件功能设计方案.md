# 商户进件功能设计方案

## 1. 业务背景分析

进件（商户入驻）是支付系统的核心功能，指商户向支付渠道（如微信支付、支付宝等）提交资质材料，经审核通过后获得支付能力的过程。

## 2. 业务模式说明

Jeepay支持两种业务模式，对应不同的接入流程：

### 模式一：服务商模式（推荐）
```
服务商（Jeepay平台） → 子商户（实际商户）
```

### 模式二：普通商户模式
```
商户直接对接各支付渠道
```

## 3. 商户接入完整流程

### 3.1 平台方准备（一次性）
```
1. Jeepay平台向各支付渠道申请服务商资质
   ├── 微信支付：申请服务商账号，获取服务商API密钥
   ├── 支付宝：申请ISV（独立软件开发商）资质
   └── 云闪付：申请收单机构资质

2. 平台获得的凭证信息：
   ├── 服务商商户号（如微信的sp_mchid）
   ├── 服务商API密钥/证书
   ├── 应用ID（如支付宝的app_id）
   └── 签名密钥等
```

### 3.2 商户进件流程（每个商户）
```
商户在Jeepay平台的完整流程：

1. 商户注册Jeepay账号
   └── 获得：mch_no（商户号）、API密钥

2. 商户提交进件申请
   ├── 上传：营业执照、法人身份证、银行卡等
   ├── 填写：商户基本信息、经营信息
   └── 选择：需要开通的支付方式

3. Jeepay平台审核
   ├── 材料完整性检查
   ├── 风险评估
   └── 人工审核

4. 向各支付渠道提交进件（关键步骤）
   ├── 使用服务商凭证调用渠道进件API
   ├── 将商户信息提交给微信/支付宝等
   └── 获得子商户号（如微信的sub_mchid）

5. 渠道审核
   ├── 各支付渠道独立审核
   ├── 审核通过后分配子商户号
   └── 回调通知Jeepay平台

6. 开通支付功能
   ├── 更新商户状态为"已开通"
   ├── 配置支付通道参数
   └── 通知商户可以开始使用
```

## 4. 系统架构设计

### 4.1 整体架构层次

```
进件功能架构
├── Controller层 (API接口)
│   ├── 商户进件申请接口
│   ├── 进件状态查询接口
│   └── 进件材料上传接口
├── Service层 (业务逻辑)
│   ├── 进件申请服务
│   ├── 材料验证服务
│   └── 渠道对接服务
├── Channel层 (渠道适配)
│   ├── 微信进件服务
│   ├── 支付宝进件服务
│   └── 云闪付进件服务
└── 基础设施层
    ├── 文件存储服务
    ├── 消息通知服务
    └── 审核工作流引擎
```

### 4.2 核心接口设计

```java
// 进件服务接口
public interface IMchApplyService {
    // 提交进件申请
    ApiRes submitApply(MchApplyRQ request);
    // 查询进件状态
    ApiRes queryApplyStatus(String applyId);
    // 上传进件材料
    ApiRes uploadMaterial(MaterialUploadRQ request);
}

// 渠道进件接口
public interface IChannelApplyService {
    String getChannelCode();
    ChannelApplyResult submitToChannel(MchApplyInfo applyInfo);
    ChannelApplyResult queryChannelStatus(String channelApplyId);
}
```

### 4.3 进件流程设计

```
进件业务流程
1. 商户提交申请 → 2. 材料验证 → 3. 提交渠道 → 4. 渠道审核 → 5. 结果通知
     ↓                ↓              ↓              ↓              ↓
   保存申请记录    验证必要材料    调用渠道API    接收审核回调    更新商户状态
```

### 4.4 状态机设计

```java
public enum ApplyStatus {
    DRAFT(0, "草稿"),
    SUBMITTED(1, "已提交"),
    CHANNEL_PROCESSING(2, "渠道处理中"),
    APPROVED(3, "审核通过"),
    REJECTED(4, "审核拒绝"),
    CANCELLED(5, "已取消");
}
```

## 5. 数据库设计

### 5.1 核心表结构

```sql
-- 商户进件申请表
CREATE TABLE `t_mch_apply_record` (
    `apply_id` VARCHAR(32) NOT NULL COMMENT '申请ID',
    `mch_no` VARCHAR(64) NOT NULL COMMENT '商户号',
    `isv_no` VARCHAR(64) COMMENT '服务商编号',
    `channel_code` VARCHAR(32) NOT NULL COMMENT '渠道代码',
    `channel_apply_id` VARCHAR(128) COMMENT '渠道申请单号',
    `apply_status` TINYINT NOT NULL DEFAULT 0 COMMENT '申请状态 0-草稿 1-已提交 2-渠道处理中 3-审核通过 4-审核拒绝 5-已取消',
    `apply_data` TEXT COMMENT '申请数据JSON',
    `audit_info` TEXT COMMENT '审核信息',
    `submit_time` TIMESTAMP(3) COMMENT '提交时间',
    `audit_time` TIMESTAMP(3) COMMENT '审核时间',
    `created_at` TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
    `updated_at` TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
    PRIMARY KEY (`apply_id`),
    KEY `idx_mch_no` (`mch_no`),
    KEY `idx_channel_apply_id` (`channel_apply_id`),
    KEY `idx_apply_status` (`apply_status`)
) COMMENT='商户进件申请记录表';

-- 进件材料表
CREATE TABLE `t_mch_apply_material` (
    `material_id` VARCHAR(32) NOT NULL COMMENT '材料ID',
    `apply_id` VARCHAR(32) NOT NULL COMMENT '申请ID',
    `material_type` VARCHAR(32) NOT NULL COMMENT '材料类型',
    `material_name` VARCHAR(128) NOT NULL COMMENT '材料名称',
    `file_url` VARCHAR(512) NOT NULL COMMENT '文件URL',
    `file_name` VARCHAR(128) COMMENT '文件名称',
    `file_size` BIGINT COMMENT '文件大小',
    `file_type` VARCHAR(32) COMMENT '文件类型',
    `is_required` TINYINT NOT NULL DEFAULT 1 COMMENT '是否必需 0-否 1-是',
    `upload_time` TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
    PRIMARY KEY (`material_id`),
    KEY `idx_apply_id` (`apply_id`),
    KEY `idx_material_type` (`material_type`)
) COMMENT='进件材料表';

-- 进件审核记录表
CREATE TABLE `t_mch_apply_audit_record` (
    `audit_id` VARCHAR(32) NOT NULL COMMENT '审核ID',
    `apply_id` VARCHAR(32) NOT NULL COMMENT '申请ID',
    `audit_type` TINYINT NOT NULL COMMENT '审核类型 1-平台审核 2-渠道审核',
    `audit_status` TINYINT NOT NULL COMMENT '审核状态 1-通过 2-拒绝',
    `audit_opinion` TEXT COMMENT '审核意见',
    `auditor` VARCHAR(64) COMMENT '审核人',
    `audit_time` TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
    PRIMARY KEY (`audit_id`),
    KEY `idx_apply_id` (`apply_id`)
) COMMENT='进件审核记录表';

-- 渠道进件配置表
CREATE TABLE `t_channel_apply_config` (
    `config_id` VARCHAR(32) NOT NULL COMMENT '配置ID',
    `channel_code` VARCHAR(32) NOT NULL COMMENT '渠道代码',
    `config_name` VARCHAR(128) NOT NULL COMMENT '配置名称',
    `required_materials` TEXT COMMENT '必需材料JSON',
    `config_params` TEXT COMMENT '配置参数JSON',
    `is_enabled` TINYINT NOT NULL DEFAULT 1 COMMENT '是否启用',
    `created_at` TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
    `updated_at` TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
    PRIMARY KEY (`config_id`),
    UNIQUE KEY `uk_channel_code` (`channel_code`)
) COMMENT='渠道进件配置表';
```

### 5.2 关键凭证信息存储

#### 平台级凭证（存储在t_isv_info表）
```java
// 服务商信息表
public class IsvInfo {
    private String isvNo;           // 服务商编号
    private String wxSpMchid;       // 微信服务商商户号
    private String wxSpAppid;       // 微信服务商应用ID
    private String wxSpApiKey;      // 微信服务商API密钥
    private String aliIsvAppid;     // 支付宝ISV应用ID
    private String aliIsvPrivateKey; // 支付宝ISV私钥
    // ... 其他渠道凭证
}
```

#### 商户级凭证（存储在t_pay_interface_config表）
```java
// 支付接口配置表
public class PayInterfaceConfig {
    private String mchNo;           // 商户号
    private String ifCode;          // 接口代码（如WX_PAY）
    private String subMchid;        // 子商户号（渠道分配）
    private String subMchAppid;     // 子商户应用ID
    private String configParams;    // 配置参数（JSON格式）
}
```

## 6. 各渠道进件实现

### 6.1 微信支付进件
```java
@Service
public class WxpayApplyService implements IChannelApplyService {
    
    public ChannelApplyResult submitToChannel(MchApplyInfo applyInfo) {
        // 1. 获取服务商凭证
        IsvInfo isvInfo = isvInfoService.getByIsvNo(applyInfo.getIsvNo());
        
        // 2. 构建进件请求
        WxPayApplymentRequest request = new WxPayApplymentRequest();
        request.setBusinessCode(applyInfo.getMchNo()); // 业务申请编号
        request.setContactInfo(buildContactInfo(applyInfo)); // 联系人信息
        request.setSubjectInfo(buildSubjectInfo(applyInfo)); // 主体信息
        request.setBusinessInfo(buildBusinessInfo(applyInfo)); // 经营信息
        request.setSettlementInfo(buildSettlementInfo(applyInfo)); // 结算信息
        
        // 3. 使用服务商凭证调用微信API
        WxPayService wxPayService = buildWxPayService(isvInfo);
        WxPayApplymentResult result = wxPayService.getApplymentService()
            .createApplyment(request);
            
        // 4. 保存申请单号，用于后续查询
        return ChannelApplyResult.success(result.getApplymentId());
    }
    
    private WxPayService buildWxPayService(IsvInfo isvInfo) {
        WxPayConfig config = new WxPayConfig();
        config.setMchId(isvInfo.getWxSpMchid());        // 服务商商户号
        config.setAppId(isvInfo.getWxSpAppid());        // 服务商应用ID
        config.setMchKey(isvInfo.getWxSpApiKey());      // 服务商API密钥
        config.setKeyPath(isvInfo.getWxSpCertPath());   // 服务商证书路径
        return new WxPayServiceImpl(config);
    }
}
```

### 6.2 支付宝进件
```java
@Service  
public class AlipayApplyService implements IChannelApplyService {
    
    public ChannelApplyResult submitToChannel(MchApplyInfo applyInfo) {
        // 1. 获取ISV凭证
        IsvInfo isvInfo = isvInfoService.getByIsvNo(applyInfo.getIsvNo());
        
        // 2. 构建AlipayClient
        AlipayClient alipayClient = new DefaultAlipayClient(
            "https://openapi.alipay.com/gateway.do",
            isvInfo.getAliIsvAppid(),           // ISV应用ID
            isvInfo.getAliIsvPrivateKey(),      // ISV私钥
            "json", "UTF-8", 
            isvInfo.getAliPublicKey(),          // 支付宝公钥
            "RSA2"
        );
        
        // 3. 构建进件请求
        AntMerchantExpandIndirectCreateRequest request = 
            new AntMerchantExpandIndirectCreateRequest();
        request.setBizContent(buildBizContent(applyInfo));
        
        // 4. 调用支付宝API
        AntMerchantExpandIndirectCreateResponse response = 
            alipayClient.execute(request);
            
        return ChannelApplyResult.success(response.getOrderId());
    }
}
```

### 6.3 云闪付进件
- **API对接**: 使用银联商务进件接口
- **必要材料**: 商户基本信息、资质证明、费率信息
- **特殊处理**: 需要预先配置机构代码

## 7. 关键技术点

### 7.1 文件上传与存储
- 支持多种文件格式（图片、PDF等）
- 文件大小限制和格式验证
- 集成OSS存储，支持文件预览

### 7.2 异步处理机制
- 使用MQ处理进件状态变更通知
- 定时任务查询渠道审核状态
- 支持进件结果回调处理

### 7.3 安全与合规
- 敏感信息加密存储
- 操作日志记录
- 权限控制和审批流程

## 8. 前端界面设计

### 8.1 管理端功能
- 进件申请管理
- 审核流程管理  
- 渠道配置管理
- 统计报表功能

### 8.2 商户端功能
- 进件申请提交
- 材料上传界面
- 进度查询页面
- 结果通知展示

## 9. 完整的商户使用流程

```
商户从注册到支付的完整流程：

1. 商户注册
   └── 获得Jeepay商户账号和API密钥

2. 提交进件申请  
   └── 上传资质材料，等待审核

3. 平台审核通过
   └── Jeepay使用服务商凭证向各渠道提交进件

4. 渠道审核通过
   └── 获得各渠道的子商户号

5. 配置支付参数
   └── 系统自动配置支付通道参数

6. 开始使用支付功能
   ├── 调用Jeepay统一下单接口
   ├── Jeepay根据子商户号调用对应渠道
   └── 完成支付流程
```

## 10. 关键优势

### 10.1 对商户的优势
- **简化接入**：商户只需对接Jeepay一套API
- **降低门槛**：无需单独申请各支付渠道资质  
- **统一管理**：一个后台管理所有支付渠道

### 10.2 对平台的优势
- **规模效应**：批量管理降低成本
- **风险控制**：统一风控和合规管理
- **商业价值**：手续费分润等商业模式

## 11. 实现优先级

### 第一阶段：核心功能
1. 数据库表结构设计
2. 基础进件申请功能
3. 微信支付进件对接
4. 基础管理界面

### 第二阶段：完善功能
1. 支付宝进件对接
2. 云闪付进件对接  
3. 文件上传优化
4. 状态查询和通知

### 第三阶段：增强功能
1. 审核工作流
2. 批量操作功能
3. 统计报表
4. 移动端适配

## 12. 扩展性考虑

### 12.1 渠道扩展
- 抽象进件接口，便于新增渠道
- 配置化的材料要求
- 灵活的审核流程配置

### 12.2 业务扩展  
- 支持批量进件
- 进件模板功能
- 自动化审核规则

这样的设计既保证了安全性（商户无需接触各渠道的敏感凭证），又简化了商户的接入流程，为Jeepay平台提供了完整的商户进件解决方案。