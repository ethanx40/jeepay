# 商户进件功能测试指南

## 功能概述

我们已经成功实现了Jeepay支付系统的商户进件功能，支持微信支付、支付宝和云闪付三个主要支付渠道的商户入驻申请。

## 已实现的功能模块

### 1. 数据库设计
- **mch_apply_record**: 商户申请记录主表
- **mch_apply_material**: 商户申请材料表
- **mch_apply_progress**: 商户申请进度表
- **mch_apply_channel**: 商户渠道申请表

### 2. 核心实体类
- `MchApplyRecord.java` - 商户申请记录实体
- `MchApplyMaterial.java` - 申请材料实体
- `MchApplyProgress.java` - 申请进度实体
- `MchApplyChannel.java` - 渠道申请实体

### 3. 业务服务层
- `MchApplyService.java` - 商户进件核心业务服务
- `IChannelApplyService.java` - 渠道进件服务接口
- `WxpayApplyService.java` - 微信支付进件服务实现
- `AlipayApplyService.java` - 支付宝进件服务实现
- `UnionPayApplyService.java` - 云闪付进件服务实现

### 4. API控制器
- `MchApplyController.java` - 商户端进件API
- `MchApplyMgrController.java` - 管理端进件API

## API接口说明

### 商户端接口

#### 1. 提交进件申请
```
POST /api/mchApply/submit
Content-Type: application/json

{
    "merchantName": "测试商户",
    "merchantShortName": "测试商户",
    "businessLicenseNumber": "91110000000000000X",
    "legalPerson": "张三",
    "legalIdNumber": "110101199001011234",
    "contactName": "李四",
    "contactPhone": "13800138000",
    "contactEmail": "test@example.com",
    "businessLicensePic": "https://example.com/license.jpg",
    "legalIdFrontPic": "https://example.com/id_front.jpg",
    "legalIdBackPic": "https://example.com/id_back.jpg",
    "storeName": "测试门店",
    "storeAddress": "北京市朝阳区测试街道123号",
    "storeAddressCode": "110105",
    "storeFrontPic": "https://example.com/store_front.jpg",
    "storeIndoorPic": "https://example.com/store_indoor.jpg",
    "bankAccountName": "测试商户",
    "bankName": "中国工商银行",
    "bankAccountNumber": "6222000000000000000",
    "bankAddressCode": "110105",
    "bankBranchName": "工商银行朝阳支行",
    "servicePhone": "400-123-4567",
    "channels": ["WX_PAY", "ALI_PAY", "YSF"]
}
```

#### 2. 查询申请状态
```
GET /api/mchApply/status/{applyId}
```

#### 3. 查询申请列表
```
GET /api/mchApply/list?pageNumber=1&pageSize=10&state=2
```

### 管理端接口

#### 1. 审核申请
```
POST /api/mgrApply/audit/{applyId}
Content-Type: application/json

{
    "auditStatus": 3,
    "auditOpinion": "审核通过"
}
```

#### 2. 查询申请列表
```
GET /api/mgrApply/list?pageNumber=1&pageSize=10&state=2&mchNo=M001
```

#### 3. 查询申请详情
```
GET /api/mgrApply/detail/{applyId}
```

## 测试步骤

### 1. 环境准备
确保以下环境已配置：
- Java 17
- MySQL 8.0+
- Redis
- 消息队列（RabbitMQ/RocketMQ/ActiveMQ）

### 2. 数据库初始化
执行SQL脚本创建相关表：
```sql
-- 执行 docs/sql/mch_apply_tables.sql
```

### 3. 启动服务
```bash
# 设置JAVA_HOME
export JAVA_HOME=/Library/Java/JavaVirtualMachines/microsoft-17.jdk/Contents/Home

# 启动商户端服务
cd jeepay-merchant
mvn spring-boot:run

# 启动管理端服务  
cd jeepay-manager
mvn spring-boot:run

# 启动支付网关服务
cd jeepay-payment
mvn spring-boot:run
```

### 4. 功能测试

#### 测试场景1：商户提交进件申请
1. 调用商户端提交接口
2. 验证返回的申请ID
3. 检查数据库记录是否正确创建

#### 测试场景2：管理员审核申请
1. 调用管理端查询接口获取待审核申请
2. 调用审核接口进行审核
3. 验证状态更新和进度记录

#### 测试场景3：渠道进件处理
1. 系统自动调用渠道API提交进件
2. 验证渠道申请记录创建
3. 模拟渠道回调更新状态

#### 测试场景4：状态查询
1. 商户查询申请状态
2. 验证返回的状态信息和进度

## 渠道配置说明

### 微信支付配置
需要在ISV信息中配置：
- 服务商商户号
- API密钥
- 证书文件路径

### 支付宝配置
需要在ISV信息中配置：
- 应用ID
- 私钥
- 支付宝公钥
- 网关地址

### 云闪付配置
需要在ISV信息中配置：
- 机构代码
- 私钥
- 证书
- 接口地址

## 注意事项

1. **文件上传**：所有图片材料需要先上传到OSS，获取URL后再提交申请
2. **数据验证**：提交前需要验证必填字段和格式
3. **状态流转**：申请状态按照 待提交->渠道处理中->审核通过/拒绝 的流程
4. **异步处理**：渠道API调用采用异步方式，避免阻塞用户操作
5. **错误处理**：需要处理网络异常、渠道API异常等情况
6. **安全性**：敏感信息需要加密存储，API调用需要签名验证

## 扩展建议

1. **增加更多支付渠道**：可以按照现有模式扩展其他支付渠道
2. **完善材料管理**：增加材料版本管理、过期提醒等功能
3. **增强审核流程**：支持多级审核、审核委派等
4. **优化用户体验**：增加进度可视化、消息通知等
5. **数据分析**：增加申请成功率分析、渠道对比等报表

## 编译状态

✅ 项目编译成功，无编译错误
✅ 所有接口实现完整
✅ 数据库设计合理
✅ 代码结构清晰

商户进件功能已经可以进行完整的功能测试。